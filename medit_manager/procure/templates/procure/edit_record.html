{% load widget_tweaks %}

<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Chá»‰nh sá»­a há»“ sÆ¡ mua sáº¯m</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-5 pb-5">

  <h3 class="mb-4 text-primary">ğŸ“ Chá»‰nh sá»­a há»“ sÆ¡ mua sáº¯m</h3>

  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <!-- Form chÃ­nh -->
    <div class="mb-3">
      {{ form.non_field_errors }}
      <label for="id_title" class="form-label">TiÃªu Ä‘á»</label>
      {{ form.title|add_class:"form-control" }}
    </div>

    <div class="mb-3">
      <label for="id_description" class="form-label">MÃ´ táº£</label>
      {{ form.description|add_class:"form-control" }}
    </div>

    <div class="mb-3">
      <label class="form-label">TÃ i liá»‡u Ä‘Ã­nh kÃ¨m (cÃ³ thá»ƒ chá»n nhiá»u)</label>
      {{ form.attachments }}
    </div>

    <hr class="my-4">

    <!-- Formset máº·t hÃ ng -->
    <h5>ğŸ“¦ Danh sÃ¡ch máº·t hÃ ng</h5>
    {{ formset.management_form }}
    <table class="table table-bordered align-middle" id="formset-table">
      <thead class="table-light">
        <tr>
          <th>TÃªn mÃ³n</th>
          <th>ÄÆ¡n vá»‹</th>
          <th>Sá»‘ lÆ°á»£ng</th>
          <th>ÄÆ¡n giÃ¡</th>
          <th>ÄÃ£ thanh toÃ¡n</th>
          <th>XoÃ¡</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="formset-body">
        {% for form in formset %}
            <tr class="form-row">
            {{ form.id }}  {# Quan trá»ng: hidden field ID Ä‘á»ƒ Django biáº¿t lÃ  Ä‘ang sá»­a dÃ²ng nÃ o #}
            {% for field in form.visible_fields %}
                <td>{{ field.errors }}{{ field }}</td>
            {% endfor %}
            <td><button type="button" class="btn btn-danger btn-sm delete-row">X</button></td>
            </tr>
        {% endfor %}

      </tbody>
    </table>

    <button type="button" class="btn btn-outline-primary mb-3" id="add-row">â• ThÃªm máº·t hÃ ng</button><br>
    <button type="submit" class="btn btn-success">ğŸ’¾ LÆ°u thay Ä‘á»•i</button>
    <a href="{% url 'procure:record_list' %}" class="btn btn-secondary">â†© Quay láº¡i</a>
  </form>

  <!-- Script thÃªm/xoÃ¡ dÃ²ng -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const addBtn = document.getElementById("add-row");
      const formsetBody = document.getElementById("formset-body");
      const totalForms = document.getElementById("id_{{ formset.prefix }}-TOTAL_FORMS");

      addBtn.addEventListener("click", function () {
        const formRows = formsetBody.querySelectorAll(".form-row");
        const currentFormCount = parseInt(totalForms.value);
        const lastRow = formRows[formRows.length - 1];
        const newRow = lastRow.cloneNode(true);

        newRow.querySelectorAll("input").forEach(input => {
          const oldName = input.name;
          const newName = oldName.replace(/-(\d+)-/, `-${currentFormCount}-`);
          input.name = newName;
          input.id = `id_${newName}`;
          if (input.type === "checkbox") {
            input.checked = false;
          } else {
            input.value = "";
          }
        });

        formsetBody.appendChild(newRow);
        totalForms.value = currentFormCount + 1;
      });

      formsetBody.addEventListener("click", function (e) {
        if (e.target.classList.contains("delete-row")) {
          const rows = formsetBody.querySelectorAll(".form-row");
          if (rows.length > 1) {
            e.target.closest(".form-row").remove();
            totalForms.value = rows.length - 1;
          } else {
            alert("Cáº§n Ã­t nháº¥t má»™t dÃ²ng!");
          }
        }
      });
    });
  </script>

</body>
</html>
